---
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Compute opposite language link
const switchTo = lang === "es" ? "en" : "es";
const switchUrl = lang === "es" ? "/" : "/es";
const switchLabel = lang === "es" ? "EN" : "ES";
---

<header
  class="flex h-[10vh] justify-between px-10 md:justify-around items-center w-screen absolute z-110 text-white opacity-0 translate-y-4 transition-all duration-700 will-change-transform fade-in-section"
>
  <h1 class="font-bold text-3xl">
    <a href={lang === "es" ? "/es" : "/"}>K’i’ik</a>
  </h1>

  <nav class="gap-10 hidden md:flex items-center">
    <a href="/#about" class="hover:text-yellow-600">{t("header.about")}</a>
    <a href="/menu" class="hover:text-yellow-600">{t("header.menu")}</a>
    <a href="/#ubicacion" class="hover:text-yellow-600">
      {t("header.location")}
    </a>

    <!-- Language Switcher -->
    <a
      href={switchUrl}
      class="ml-4 px-3 py-1 border border-white/50 rounded-md text-sm hover:bg-white hover:text-black transition-colors duration-200"
    >
      {switchLabel}
    </a>
  </nav>

  <!-- Mobile Menu Button -->
  <button
    id="mobile-menu-btn"
    class="text-3xl font-bold md:hidden transition-transform duration-300"
  >
    ☰
  </button>

  <!-- Mobile Menu -->
  <nav
    id="mobile-menu"
    class=`absolute top-20 left-0 w-full z-100 overflow-hidden max-h-0 transition-all duration-500 ${Astro.url.pathname === "/" || Astro.url.pathname === "/es" ? "bg-transparent" : Astro.url.pathname.startsWith("/menu") || Astro.url.pathname.startsWith("/es/menu") ? "bg-black" : "bg-black"}`
  >
    <div class="flex flex-col">
      <a
        href="/#about"
        class="px-10 py-3 hover:bg-white/40 hover:text-black cursor-pointer border-b border-white/40 text-center"
      >
        {t("header.about")}
      </a>
      <a
        href="/menu"
        class="px-10 py-3 hover:bg-white/40 hover:text-black cursor-pointer border-b border-white/40 text-center"
      >
        {t("header.menu")}
      </a>
      <a
        href="/#ubicacion"
        class="px-10 py-3 hover:bg-white/40 hover:text-black cursor-pointer border-b border-white/40 text-center"
      >
        {t("header.location")}
      </a>

      <!-- Language Switcher (Mobile) -->
      <a
        href={switchUrl}
        class="px-10 py-3 hover:bg-white/40 hover:text-black cursor-pointer text-center"
      >
        {switchLabel}
      </a>
    </div>
  </nav>
</header>

<script>
  const mobileMenuBtn = document.getElementById(
    "mobile-menu-btn"
  ) as HTMLButtonElement | null;
  const mobileMenu = document.getElementById(
    "mobile-menu"
  ) as HTMLElement | null;

  if (mobileMenuBtn && mobileMenu) {
    let menuOpen = false;

    mobileMenuBtn.addEventListener("click", () => {
      menuOpen = !menuOpen;
      if (menuOpen) {
        mobileMenu.style.maxHeight = `${mobileMenu.scrollHeight}px`;
        mobileMenuBtn.textContent = "✕";
      } else {
        mobileMenu.style.maxHeight = "0";
        mobileMenuBtn.textContent = "☰";
      }
    });

    document.addEventListener("click", (e: MouseEvent) => {
      const target = e.target as Node; // ✅ Explicit cast

      if (
        !mobileMenuBtn.contains(target) &&
        !mobileMenu.contains(target) &&
        menuOpen
      ) {
        menuOpen = false;
        mobileMenu.style.maxHeight = "0";
        mobileMenuBtn.textContent = "☰";
      }
    });

    mobileMenu.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", () => {
        menuOpen = false;
        mobileMenu.style.maxHeight = "0";
        mobileMenuBtn.textContent = "☰";
      });
    });
  }
</script>
